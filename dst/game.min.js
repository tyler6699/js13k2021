var o,n=[];function a(t,e){for(m=o.createBuffer(1,96e3,48e3),gainNode=o.createGain(),b=m.getChannelData(0),i=96e3;i--;)b[i]=getSound(t,i);s=o.createBufferSource(),s.buffer=m,s.connect(gainNode),gainNode.connect(o.destination),gainNode.gain.value=e,s.start()}function u(e){if(t=((t,e)=>(e-t)/e),e>7e4)return null;t(e,7e4);return Math.sin(.001*e*Math.sin(.009*e)+Math.sin(e/100))}function d(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return(128&Math.pow(t,1.055)?1:-1)*Math.pow(e,2)}function p(t){if(t>5e4)return null;var e=(5e4-t)/5e4;return(200&Math.pow(t,.9)?1:-1)*Math.pow(e,3)}function v(t){var e=1e4;if(t>e)return null;var i=(e-t)/e,s=Math.pow(i,2.1);return Math.pow(t,3)&(t<3333.3333333333335?16:99)?s:-s}function T(t){if(t>2e4)return null;var e=(2e4-t)/2e4;return Math.sin(.003*-t*Math.sin(.09*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function g(t){if(t>1e4)return null;var e=(1e4-t)/1e4;return Math.sin(.01*t*Math.sin(.009*t+Math.sin(t/200))+Math.sin(t/100))*e*e}function k(e){if(e>2e3)return null;t=((t,e)=>(e-t)/e);var i=t(e,2e3);return 33&Math.pow(50*e,.7)?i:-i}function O(e){if(t=((t,e)=>(e-t)/e),e>2e4)return null;var i=t(e,2e4);return e*=.04,Math.sin(.03*-e*Math.sin(.09*e+Math.sin(e/200))+Math.sin(e/100))*i}function R(){this.scale=4,this.cube=16,this.scaled=this.scale*this.cube,this.hero=new q(16,16,tt/2,et/2,0,L.HERO,this.scale),this.surTiles=[-1,1,18,19,20,-18,-19,-20],this.introT=0,this.shake=0,this.shakeTime=0,this.reset=!1,this.wait=2,this.genLevel=function(t){if(5==t){B("BOSS LEVEL"),this.levels=[],(e=new F(t,tt,et,i,this.scale,!0)).reset(i,this.scaled),this.levels.push(e),this.level=e}else{for(this.bkcol=I(),this.levels=[],i=0;i<9;i++){var e;(e=new F(t,tt,et,i,this.scale)).reset(i,this.scaled),this.levels.push(e)}this.level=this.levels[0],this.hero.e.currentLevel=0}},this.genLevel(0),this.update=function(t,e){this.shake=gt?Math.cos(nt):0,this.door=null,Ht()&&(this.hero.e.x-=this.hero.gMove(-1,0),this.hero.e.flip=!0),It()&&(this.hero.e.x+=this.hero.gMove(1,0),this.hero.e.flip=!1),Ct()&&(this.hero.e.y-=this.hero.gMove(0,-1)),Bt()&&(this.hero.e.y+=this.hero.gMove(0,1)),this.hero.checkDoor(),this.hero.setCurrentTile(this.scaled),this.hero.checkGun(),K(nt),N(ctx,80,120,0,0,1080,710,this.bkcol,.8),this.level.draw(this.hero.e,t),gradient=ctx.createLinearGradient(0,0,tt,0),gradient.addColorStop("0","#"+ft),gradient.addColorStop(".5","#"+xt),ctx.fillStyle=gradient,ctx.font="italic 40px Arial",ctx.fillText("AMMO "+this.hero.e.gun.ammo,900,50),5!=wt?ctx.fillText("LEVEL "+(wt+1),600,50):ctx.fillText("BOSS FIGHT",600,50),ct=!1,this.hero.update(t),Lt.canvas.style.cursor="none";let s=at.x,o=at.y;if(ctx.fillStyle="BLACK",ctx.globalAlpha=.4,w=8,h=40,ctx.fillRect(s-4,o-20,w,h),ctx.fillRect(s-20,o-4,h,w),this.introT>0){for(i=0;i<=tt/33;i++)for(j=0;j<=et/33;j++)ctx.save(),ctx.translate(32*i,32*j),col=i%2==0&&j%2==0?"#000":"#FFF",ctx.fillStyle=col,ctx.globalAlpha=.5,ctx.fillRect(this.introT/-2,this.introT/-2,this.introT,this.introT),ctx.restore();this.introT-=48*t}this.level.mobs=this.level.mobs.filter(function(t){return 1==t.entity.active}),0!=this.level.mobs.length||this.level.gatesOpen||(this.level.openDoors(),this.hero.roomsDone>=0&&this.hero.roomsDone++),5==wt&&0==this.level.mobs.length&&(pt=!0,this.wait-=t,pt&&this.wait<=0&&!this.reset&&(B("You have survived the planet, a ship is on its way to rescue space kitty!"),pt=!1,this.reset=!0,this.wait=3),this.wait<=0&&this.reset&&(yt=!0)),9==this.hero.roomsDone&&!l.showPortal&&wt<5&&(l=this.levels[this.hero.e.currentLevel],l.showPortal=!0,this.hero.roomsDone=-1,tile=this.levels[this.hero.e.currentLevel].tiles[142],tile.entity.type=L.PC,tile.entity.setType(),B("Terminal Available.")),Wt()&&this.renderMap(),this.renderHP()},this.renderHP=function(){ctx.save(),ctx.translate(0,0),ctx.globalAlpha=1,ctx.fillStyle="#001832",ctx.fillRect(20,20,300,40),ctx.fillStyle="#a12161",l=2.8*this.hero.e.hp,ctx.fillRect(30,30,l,20),ctx.restore()},this.renderMap=function(){ctx.save(),ctx.translate(0,0),ctx.globalAlpha=.8,ctx.fillStyle="WHITE",offX=tt/2-180,offY=et/2-180,this.levels.forEach((t,e)=>{var i=e%3*120,s=120*Math.floor(e/3);c=t.gatesOpen?"#a12161":"#001832",t.showPortal&&(c="GOLD"),ctx.fillStyle=c,ctx.fillRect(i+offX,s+offY,100,100),this.level==t&&(ctx.fillStyle="BLACK",ctx.fillRect(i+offX+.065*this.hero.e.x,s+offY+.095*this.hero.e.y,20,20))}),ctx.restore()}}function M(t,e,i){this.active=!0,this.open=!1,this.loadRoom=t,this.exitX=e,this.exitY=i}getSound=function(t,e){var i;switch(t){case ee:i=u(e);break;case ie:i=v(e);break;case se:i=d(e);break;case he:i=p(e);break;case oe:i=T(e);break;case ne:i=g(e);break;case re:i=k(e);break;case ae:i=O(e);break;default:return 1}return i};const L={FLOOR:1,AIR:2,HERO:3,GRID_1:4,GRID_2:5,GRID_3:6,GRID_4:7,WALL:8,ROCK_1:9,ROCK_2:10,ROCK_3:12,ROCK_4:13,DOOR:14,DOOR_BLOCK:15,DOOR_WALL:16,BARREL:17,TREE:18,CUBE:19,PC:20,AMMO:21,UPGRADE:22,BOT:23,TNY:24,HP:25},S={GUN:0,DESK:1,CHAIR:2,PC:3,SERVER:4,VEND:5,AUTO:6,UP:7},A={FOLLOW:0,SIMPLE:1},E={ONESHOT:0,TWOSHOT:1,THREESHOT:2,MULTISHOT:3};function D(t,e,i,s,h,o,n,r){this.entity=new V(t,t,e,i,s,h,"",4,0,0),this.column=n,this.row=r,this.active=!0,this.door=null,this.update=function(t){this.entity.update(t)},this.change=function(){this.entity.type>=Object.values(L).length&&(this.entity.type=0),this.entity.setType()},this.doorSet=function(){return null!=this.door},this.isTile=function(){return!0},this.isDoor=function(){return null!=this.door}}function H(t,e,i,s){this.x=t,this.y=e,this.w=i,this.h=s}function I(){for(var t="#",e=0;e<6;e++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t}var C="Google UK English Female";function B(t){var e=new SpeechSynthesisUtterance;e.text=t,e.voice=speechSynthesis.getVoices().filter(function(t){return t.name==C})[0],speechSynthesis.speak(e)}function Y(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function W(t){return new H(t.x,t.y,t.w,t.h)}function P(t,e,i,s,h,o,n,r){return t<h+n&&t+i>h&&e<o+r&&e+s>o}function _(t,e){return t.x<e.x+e.w&&t.x+t.w>e.x&&t.y<e.y+e.h&&t.y+t.h>e.y}function U(t,e){this.x=t,this.y=e,this.set=function(t,e){this.x=t,this.y=e}}function K(t){ctx.fillStyle="#FFF";for(let e=2e3;e--;)x=(1e9*Math.sin(e)-t/2e3*(e+1e3)/50)%(Lt.canvas.width+9)-9,y=9*e%tt,s=e%5,ctx.fillRect(x,y,s,s)}function G(t){for(i=200;i--;ctx.fillRect(tt/2+i*Math.sin(i)*Z,423+i*Math.cos(9*i)*Z,Z,Z))ctx.fillStyle="rgba(255,255,255,"+(i+.1)+")",Z=2**Math.tan(i/9+t/3)}function X(t,e,i,s,h,o,n,r,a,l){t.save(),t.globalAlpha=a,t.translate(n,r),t.drawImage(e,i,s,h,o,h/2,o/2,h*l,o*l),t.restore()}function N(t,e,i,s,h,o,n,r,a){t.save(),t.globalAlpha=a,t.translate(e,i),t.fillStyle=r,t.fillRect(s,h,o,n),t.restore()}function F(t,e,i,s,h,o=!1){wt=t,this.tiles=[],this.breakTiles=[],this.mvTiles=[],this.mobs=[],this.active=!1,this.complete=!1,this.roomNo=s,this.gatesOpen=!1,this.showPortal=!1;function n(t){return t==L.AIR}function a(t,e){return 1==e||17==e||1==t&&1==e||1==t&&17==e||1==t&&e>1&&e<17||11==t&&17==e||11==t&&1==e||11==t&&e>1&&e<17}function l(t,e){return t>2&&t<11&&e>1&&e<17}this.draw=function(t,e){this.dTiles.forEach(t=>t.update(e)),this.tiles.forEach(t=>t.update(e)),this.mobs.forEach(t=>t.update(e)),this.mvTiles.forEach((t,e)=>{0!=t.entity.mvY&&t.entity.mvY>0&&(t.entity.y++,t.entity.mvY--),0==t.entity.mvY&&(t.entity.alpha=.5,t.entity.isSolid=!1,t.entity.renT2=!0)}),this.mvTiles=this.mvTiles.filter(function(t){return 0!=t.entity.mvY}),this.breakTiles=this.tiles.filter(function(t){return 1==t.entity.breaks})},this.reset=function(t,e){boss=5==wt,this.tiles=[],this.dTiles=[],this.mobs=[],this.showPortal=!1;for(r=0;r<13;r++)for(c=0;c<19;c++)if(xx=c*e,yy=r*e,r>1&&r<12&&c>0&&c<18){var i=null;Y(0,100)>80?i=4:Y(0,100)>70?i=5:Y(0,100)>70?i=6:Y(0,100)>70&&(i=7),null!=i&&this.dTiles.push(new D(16,xx,yy,0,i,!1,c,r))}for(ammo=0,tin=0,upgrade=Y(0,100)>95-wt,r=0;r<13;r++){for(c=0;c<19;c++){var s;ts=16*h,xx=c*ts,yy=r*ts;i=L.WALL;2==r&&c>1&&c<17?i=L.WALL:12==r&&c>0&&c<18?i=L.WALL:0==r||0==c||12==r||18==c?i=L.AIR:a(r,c)?i=L.BLOCK:(i=L.AIR,Y(0,100)>90&&r>2&&(i=[9,10,12,13][Y(0,3)])),l(r,c)&&!boss&&(o||(Y(0,100)>98&&n(i)&&tin<5&&(i=L.BARREL,tin++),upgrade&&Y(0,100)>70&&n(i)&&(i=L.UPGRADE,upgrade=!1),Y(0,100)>98&&n(i)&&(i=L.TREE),Y(0,100)>99&&n(i)&&(i=L.CUBE),Y(0,1e3)>985&&n(i)&&ammo<3&&(i=L.AMMO,ammo++))),s=new D(16,xx,yy,0,i,!1,c,r),this.tiles.push(s)}12==r&&19==c&&(tin=0,ammo=0)}if(boss)for(m=0;m<35;m++)mb=new J(9,10,Y(124,1028),Y(124,644),0,L.TNY,h,5),mb.type=A.SIMPLE,this.mobs.push(mb);else if(!o){switch(t){case 0:this.doorR(),this.doorB();break;case 1:this.doorR(),this.doorL(),this.doorB();break;case 2:this.doorL(),this.doorB();break;case 3:this.doorR(),this.doorB(),this.doorT();break;case 4:this.doorR(),this.doorL(),this.doorT(),this.doorB();break;case 5:this.doorL(),this.doorT(),this.doorB();break;case 6:this.doorR(),this.doorT();break;case 7:this.doorR(),this.doorL(),this.doorT();break;case 8:this.doorT(),this.doorL()}for(noMobs=Y(1,3)+wt,m=0;m<2*noMobs;m++)m>=noMobs?(mb=new J(9,10,Y(124,1028),Y(124,644),0,L.TNY,h,0),mb.type=A.SIMPLE):mb=new J(16,16,Y(124,1028),Y(124,644),0,L.BOT,h,Y(1,3+wt)),this.mobs.push(mb)}},this.openDoors=function(){this.gatesOpen=!0,this.tiles.forEach((t,e)=>{t.entity.isDoorWall()?t.entity.setT(L.AIR):t.entity.isDoorTop()&&(t.entity.mvY=48,this.mvTiles.push(t)),null!=t.door&&(t.door.open=!0)})},this.doorR=function(){[113,132,151].forEach(t=>this.addDoor(t,s+1,130,-1,L.AIR,!0)),[112,131,150].forEach(t=>this.addDoor(t,0,0,0,L.DOOR_BLOCK,!1))},this.doorL=function(){[95,114,133].forEach(t=>this.addDoor(t,s-1,1024,-1,L.AIR,!0)),[96,115,134].forEach(t=>this.addDoor(t,0,0,0,L.DOOR_BLOCK,!1))},this.doorB=function(){[236,237,238].forEach(t=>this.addDoor(t,s+3,-1,160,L.DOOR_WALL,!0)),[217,218,219].forEach(t=>this.addDoor(t,0,0,0,L.DOOR_BLOCK,!1))},this.doorT=function(){[27,28,29].forEach(t=>this.addDoor(t,s-3,-1,640,L.DOOR_BLOCK,!0)),[46,47,48].forEach(t=>this.addDoor(t,0,0,0,L.DOOR_WALL,!1))},this.addDoor=function(t,e,i,s,h,o=!1){tile=this.tiles[t],tile.entity.setT(h),o&&(tile.door=new M(e,i,s)),[112,96].includes(t)&&(tile.entity.type2=L.DOOR_WALL),[217,218,219,27,28,29].includes(t)&&(tile.entity.type3=L.DOOR_WALL)},this.addAir=function(t){this.tiles[t].entity.setT(L.AIR)},this.addWall=function(t){this.tiles[t].entity.setT(L.WALL)}}function V(t,e,i,h,o,n,r,a,l=!1,c=0){this.scale=a,this.type=n,this.type2=null,this.renT2=!1,this.type3=null,this.t3yOff=0,this.renT3=!1,this.width=t,this.height=e,this.mhWidth=t/-2,this.mhHeight=e/-2,this.mhWScaled=t/-2*a,this.mhHScaled=e/-2*a,this.hWidth=t/2,this.hHeight=e/2,this.yOffset=0,this.angle=o,this.x=i,this.y=h,this.active=!0,this.colour=r,this.image=Tt,this.animated=!1,this.anination=null,this.alpha=1,this.currentTile=0,this.colArr=[],this.isSolid=!1,this.isButton=l,this.pc=null,this.gun=null,this.ammo=5,this.time=0,this.showText="",this.showTextTime=0,this.showTextY=0,this.shootTime=0,this.maxHP=c,this.hp=this.maxHP,this.mvY=0,this.breaks=!1,this.flip=!1,this.idle=0,this.sx=0,this.sy=0,this.setHitbox=function(){this.hb=new H(0,0,0,0),this.sensor=new H(0,0,0,0),this.isButton&&(this.hb.w=2*this.width,this.hb.h=2*this.height)},this.setHitbox(),this.updateHitbox=function(){this.isButton?(this.hb.x=this.x-this.width,this.hb.y=this.y-this.height):(this.hb.x=this.x+this.scale/2,this.hb.y=this.y+this.scale/2,this.hb.w=this.width*this.scale-this.scale,this.hb.h=this.height*this.scale-this.scale,this.sensor.x=this.x-5,this.sensor.y=this.y-5,this.sensor.w=this.width*this.scale+10,this.sensor.h=this.height*this.scale+10)},this.update=function(i){this.idle+=i,this.updateHitbox(),this.active&&!this.isFloor()&&(ctx.save(),ctx.translate(this.x,this.y),ctx.rotate(this.angle),ctx.globalAlpha=this.alpha,img=this.image,s=this.scale,mhw=this.mhWidth,mhh=this.mhHeight,hw=this.hWidth,hh=this.hHeight,t=this.width,e=this.height,kt.shakeTime>0&&(kt.shakeTime-=i/1e3,ctx.translate(kt.shake,kt.shake)),ctx.save(),null==this.image?(ctx.fillStyle=this.colour,ctx.fillRect(.5*mhw*s,.5*mhh*s,.5*t*s,.5*e*s)):(this.flip?(ctx.scale(-1,1),ctx.translate(-80,0)):ctx.scale(1,1),f=0,z=0,this.type==L.BOT&&(f=10*Math.sin(nt/500),z=5*Math.cos(nt/700),ctx.drawImage(img,97,56,7,2,t+hw+z,5*e,30,10)),ctx.drawImage(img,this.sx,this.sy,t,e,hw+z,hh+f,t*s,e*s)),ctx.restore(),null!=this.type2&&0!=this.mvY?(ctx.translate(0,-48+this.mvY),ctx.drawImage(img,0,16,t,e,hw,hh,t*s,e*s),ctx.translate(0,48-this.mvY),ctx.drawImage(img,this.sx,this.sy,t,e,hw,hh,t*s,e*s)):null!=this.type3&&0!=this.mvY?(ctx.translate(0,64-(48-this.mvY)),ctx.drawImage(img,112,16,t,e,hw,hh,t*s,e*s),ctx.translate(0,48-this.mvY-64),ctx.drawImage(img,this.sx,this.sy,t,e,hw,hh,t*s,e*s)):null!=this.type2&&this.renT2&&(ctx.globalAlpha=1,ctx.translate(0,-48),ctx.drawImage(img,0,16,t,e,hw,hh,t*s,e*s)),this.showTextTime>0&&(this.showTextTime-=i,gradient=ctx.createLinearGradient(0,0,tt,0),gradient.addColorStop("0","#"+ft),gradient.addColorStop(".1","#"+xt),s=25+5*this.showTextTime,ctx.font="italic "+s+"px Arial",ctx.fillStyle=gradient,ctx.fillText(this.showText,0,this.showTextY+10*this.showTextTime)),ctx.restore())},this.isHero=function(){return this.type==L.HERO},this.isDoor=function(){return this.type==L.DOOR||this.type==L.DOOR_BLOCK||this.type==L.DOOR_WALL},this.isDoorWall=function(){return this.type==L.DOOR_WALL},this.isDoorTop=function(){return this.type==L.DOOR_BLOCK},this.isBarrel=function(){return this.type==L.BARREL},this.isTree=function(){return this.type==L.TREE},this.isTile=function(){return!1},this.isAmmo=function(){return this.type==L.AMMO},this.isHP=function(){return this.type==L.HP},this.isUpgrade=function(){return this.type==L.UPGRADE},this.setT=function(t){this.type=t,this.setType()},this.isFloor=function(){return this.type==L.FLOOR},this.isPortal=function(){return this.type==L.PC},this.setType=function(){switch(this.alpha=1,this.sy=0,this.sx=0,this.isSolid=!1,this.type){case L.HERO:this.isSolid=!0,this.sx=96,this.sy=16;break;case L.WALL:this.sy=16;break;case L.BLOCK:this.isSolid=!0,this.sx=16;break;case L.FLOOR:this.sx=32,this.sy=32,this.alpha=.9;break;case L.AIR:case L.DOOR:this.sx=144;break;case L.DOOR_BLOCK:this.isSolid=!0,this.sx=112;break;case L.DOOR_WALL:this.sy=16,this.sx=112;break;case L.GRID_1:this.sx=96,this.sy=32;break;case L.GRID_2:this.sx=112,this.sy=32;break;case L.GRID_3:this.sx=80,this.sy=32;break;case L.GRID_4:this.sx=48,this.sy=32;break;case L.ROCK_1:this.sx=48;break;case L.ROCK_2:this.sx=64;break;case L.ROCK_3:this.sx=80;break;case L.ROCK_4:this.sx=96;break;case L.BARREL:this.isSolid=!0,this.hp=3,this.breaks=!0,this.sx=48,this.sy=16;break;case L.TREE:this.isSolid=!0,this.breaks=!0,this.sx=16,this.sy=32;break;case L.CUBE:this.isSolid=!0,this.hp=5,this.breaks=!0,this.sx=32,this.sy=16;break;case L.PC:this.sx=80,this.sy=16;break;case L.AMMO:this.sx=64,this.sy=32;break;case L.UPGRADE:this.sx=48,this.sy=48;break;case L.BOT:this.isSolid=!0,this.sx=80,this.sy=48;break;case L.TNY:this.isSolid=!0,xs=[96,105,114],this.sx=xs[Y(0,2)],this.sy=48;break;case L.HP:}},this.setType()}function q(t,i,s,h,o,n,r){this.e=new V(t,i,s,h,o,n,"",r,!1,100),this.e.hp=100,this.e.gun=new le,this.speed=5,this.door=null,this.currentTile=null,this.roomsDone=0,this.level=0,this.levelUp=!1,this.levelUpTime=0,this.noAmmo=0,this.update=function(t){this.e.hp<=0&&(yt=!0,B("Oh no! You have failed to escape the planet.")),this.e.idle>3?(this.e.sx=128,this.e.sy=0,this.e.showTextTime<=0&&(this.e.showText="Z",this.e.showTextTime=2)):(this.e.sx=96,this.e.sy=16),this.time+=t,this.e.gun.drawBullets(t),this.e.update(t)},this.checkGun=function(){ut&&(dt+=st),(ct||dt>.25)&&(this.e.idle=0,ox=this.e.x-this.e.mhWScaled,oy=this.e.y-this.e.mhHScaled,dx=lt.x,dy=lt.y,this.e.gun.addBullets(ox,oy,dx,dy))},this.checkDoor=function(){null!=this.door&&(this.e.gun.bullets=[],kt.level=kt.levels[this.door.loadRoom],this.e.currentLevel=this.door.loadRoom,-1!=this.door.exitX&&(this.e.x=this.door.exitX),-1!=this.door.exitY&&(this.e.y=this.door.exitY),this.door=null,kt.introT=32,a(ae,5))},this.setCurrentTile=function(t){heroRow=Math.floor((this.e.y-this.e.mhHScaled)/t),heroCol=Math.floor((this.e.x-this.e.mhWScaled)/t),heroTileIndex=heroCol+19*heroRow,null!=this.currentTile&&(this.prevTile=this.currentTile),this.currentTile=kt.level.tiles[heroTileIndex],this.currentTile!=this.prevTile&&(this.e.colArr=[],kt.surTiles.forEach(t=>this.e.colArr.push(kt.level.tiles[heroTileIndex+t])),kt.level.mobs.forEach(t=>this.e.colArr.push(t.entity)))},this.gMove=function(t,i){this.e.idle=0,rec=W(this.e.hb),rec.x+=t*this.speed,rec.y+=i*this.speed,amount=this.speed,stop=!1,canMove=!0;for(var s=this.speed;s>0;s--){canMove=!0;for(var h=0;h<this.e.colArr.length;h++)if(obj=this.e.colArr[h],e=obj.entity,obj.isTile()){if(!stop&&_(e.hb,rec)){if(e.isPortal()&&!this.levelUp){canMove=!1,this.levelUp=!0,this.level++,a(ee,.5),this.roomsDone=0,wt++,kt.genLevel(wt);break}if(e.isHP()&&!e.broke)e.broke=!0,e.active=!1,hpUp=Y(10,40),this.e.hp+=hpUp,this.e.hp>e.maxHP&&(this.e.hp=this.e.maxHP),this.e.showTextTime=1,this.e.showText="+"+hpUp+" health",a(ie,.5);else if(e.isAmmo()&&!e.broke)ad=Y(10,25),0==this.e.gun.ammo&&B("Try not to run out of ammo!"),this.e.gun.ammo+=ad,this.e.showTextTime=1,this.e.showText="Ammo +"+ad,e.sy=16,e.sx=64,e.broke=!0,a(ie,.5);else if(e.isUpgrade()&&!e.broke)ad=Y(10,25),this.e.gun.type++,this.e.showTextTime=1,this.e.showText="UPGRADE!",e.sx=64,e.broke=!0,a(ae,.5);else{if(obj.active&&e.isSolid){canMove=!1;break}if(obj.isDoor&&obj.doorSet()){this.door=obj.door,stop=!0;break}}e.isBarrel()&&(this.e.hp-=.5)}}else if(!stop&&obj.active&&obj.isSolid&&_(obj.hb,rec)){canMove=!1;break}if(canMove||stop)break;amount--,rec.x-=t,rec.y-=i}return amount}}function J(t,i,s,h,o,n,r,a){this.entity=new V(t,i,s,h,o,n,"",r,!1,a),this.type=A.FOLLOW,this.entity.gun=new le,this.entity.gun.rate=Y(0,3)+.5-wt/10,this.entity.gun.rate<.1&&(this.entity.gun.rate=.2),n==L.TNY?(this.bspd=150,this.spd=.5,this.entity.gun.rate=1):(this.bspd=800,this.spd=Y(1,3)-.5),this.colArr=[],this.noX=!1,this.noY=!1,this.waitX=1,this.waitY=1,this.time=0,this.tryXSpeed=this.spd,this.tryYSpeed=this.spd,this.entity.gun.wait=Y(0,3)-wt,this.update=function(t){this.time+=t,this.time>2&&(this.time=0,this.noX=!1,this.noY=!1,this.waitY=0,this.waitX=0,this.tryXSpeed=Y(0,10)>5?this.spd:-this.spd,this.tryYSpeed=Y(0,10)>5?this.spd:-this.spd);var i=this.entity.x,s=this.entity.y;row=Math.floor((s-this.entity.mhHScaled)/kt.scaled),col=Math.floor((i-this.entity.mhWScaled)/kt.scaled),index=col+19*row,e=this.entity,ny=s<kt.hero.e.y?s+=this.move(0,this.spd):s+=this.move(0,-this.spd),nx=i<kt.hero.e.x?i+=this.move(this.spd,0):i+=this.move(-this.spd,0),this.type==A.FOLLOW?(this.noX&&this.waitX>0?(this.waitX-=t,e.y=s+=this.move(0,this.tryYSpeed)):e.y=ny,this.noY&&this.waitY>0?(this.waitY-=t,e.x=i+=this.move(this.tryXSpeed,0)):e.x=nx):this.type==A.SIMPLE&&(e.y=ny,e.x=nx),this.colArr=[],kt.surTiles.forEach(t=>this.colArr.push(kt.level.tiles[index+t].entity)),this.colArr.push(kt.hero.e),kt.level.mobs.forEach(t=>this.colArr.push(t.entity)),e.update(t),e.hp<e.maxHP&&(X(ctx,e.image,0,32,16,8,e.x,e.y+74,.8,e.scale),N(ctx,e.x,e.y+72,16,14,48/e.maxHP*e.hp,12,"#00dcf8",.8)),this.entity.gun.addBullets(this.entity.x+32,this.entity.y+32,kt.hero.e.x+32,kt.hero.e.y+32,!0,this.entity.type,this.bspd),this.entity.gun.drawBullets(t,!0)},this.move=function(t,e){rec=W(this.entity.hb),rec.x+=t,rec.y+=e,canMove=!0,amount=t+e;for(var i=0;i<this.colArr.length;i++)if(obj=this.colArr[i],obj!=this.entity&&obj.isSolid&&_(obj.hb,rec)){canMove=!1,amount=0;break}return 0==amount?0!=t?(this.noX=!0,this.waitX=.8):(this.noY=!0,this.waitY=.8):0!=t&&0==this.waitX?this.noX=!1:0==this.waitY&&(this.noY=!1),amount}}var Q,$,tt=1232,et=846,it=!1,st=0,ht=Date.now(),ot=Date.now(),nt=0,rt=0,at=new U(0,0),lt=new U(0,0),ct=!1,ut=!1,dt=0,yt=!1,xt="990099",ft="05f2db",mt=1e3,pt=!1,vt=101,bt=600,wt=1,Tt=new Image;Tt.src="atlas.png";var gt=!0,kt=new R,Ot=speechSynthesis.getVoices(),Rt=!0,Mt=!1;function startGame(){Lt.start()}var Lt={canvas:document.createElement("canvas"),start:function(){this.canvas.width=tt,this.canvas.height=et,this.context=this.canvas.getContext("2d"),this.context.scale(1,1),ctx=this.context,ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.imageSmoothingEnabled=!1,this.canvas.classList.add("screen"),document.body.insertBefore(this.canvas,document.body.childNodes[6]),this.frameNo=0,this.interval=setInterval(At,20),window.addEventListener("keydown",function(t){t.preventDefault(),Lt.keys=Lt.keys||[],Lt.keys[t.keyCode]="keydown"==t.type}),window.addEventListener("keyup",function(t){Lt.keys[t.keyCode]="keydown"==t.type,t.keyCode==qt&&(gt=!gt),t.keyCode==Jt&&(kt.bkcol=I()),t.keyCode==te&&(yt=!0)}),window.addEventListener("mousedown",function(t){t.preventDefault(),Lt.keys=Lt.keys||[],Lt.keys[t.button]=!0,ut=!0}),window.addEventListener("mouseup",function(t){t.preventDefault(),Lt.keys=Lt.keys||[],Lt.keys[t.button]=!1,ut=!1,dt=0,ct=!0,!Mt&&nt>2e3&&(Mt=!0),St()}),window.addEventListener("mousemove",function(t){t.preventDefault();var e=Lt.canvas.getBoundingClientRect();at.set((t.clientX-e.left)/(e.right-e.left)*tt,(t.clientY-e.top)/(e.bottom-e.top)*et),row=Math.floor(at.y/this.scaled),col=Math.floor(at.x/this.scaled),St()}),this.canvas.oncontextmenu=function(t){t.preventDefault()}},stop:function(){clearInterval(this.interval)},clear:function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}};function St(){lt.set(at.x,at.y)}function At(){if(yt){nt=0;var e=kt.hero;e.e.hp=100,e.e.gun=new le,e.roomsDone=0,e.levelUpTime=0,e.levelUp=!1,yt=!1,pt=!1,wt=0,Mt=!1,it=!1,kt.genLevel(wt)}Mt&&nt>2e3&&(null!=kt.hero&&(kt.hero.e.active=!0),it=!0,null==o&&(o=new AudioContext)),ht=ot,ot=Date.now(),nt+=st=ot-ht,it?kt.hero.levelUp&&wt<=4?(Lt.clear(),G(nt/100),t=nt/1e3,x=488+40*Math.cos(t),y=295+20*Math.sin(t),ctx.globalAlpha=1,ctx.drawImage(kt.hero.e.image,96,16,16,13,x-80,y+40,256,208),ctx.drawImage(kt.hero.e.image,32,48,16,16,x,y,256,256),kt.hero.levelUpTime+=st/1e3,kt.hero.levelUpTime>2&&(kt.hero.levelUpTime=0,kt.hero.levelUp=!1,B("level "+wt+" completed."))):(Lt.clear(),kt.update(st/1e3,nt)):(Lt.clear(),ctx=Lt.context,ctx.save(),Et(ctx,.1,"#"+xt,0,0,tt,et),txt=nt>2e3?"[ CLICK TO START ]":"[ LOADING ]",Dt(ctx,1,"italic 50px Arial","WHITE",txt,380,720),z=nt/1600,Dt(ctx,1,"italic 90px Arial","WHITE","SPACE KITTY",300+40*Math.cos(z),150+20*Math.sin(z)),Dt(ctx,1,"italic 60px Arial","WHITE","was not the imposter!",300+70*Math.cos(z),200+20*Math.sin(z)),K(nt),ctx.setTransform(1,0,0,1,0,0),t=nt/1e3,x=488+40*Math.cos(t),y=295+20*Math.sin(t),ctx.drawImage(kt.hero.e.image,96,16,16,13,x-80,y+40,256,208),ctx.drawImage(kt.hero.e.image,32,48,16,16,x,y,256,256))}function Et(t,e,i,s,h,o,n){t.globalAlpha=e,t.fillStyle=i,t.fillRect(s,h,o,n)}function Dt(t,e,i,s,h,o,n){t.globalAlpha=e,t.font=i,t.fillStyle=s,t.fillText(h,o,n)}function Ht(){return Lt.keys&&(Lt.keys[Pt]||Lt.keys[Xt])}function It(){return Lt.keys&&(Lt.keys[_t]||Lt.keys[Nt])}function Ct(){return Lt.keys&&(Lt.keys[Ut]||Lt.keys[Gt])}function Bt(){return Lt.keys&&(Lt.keys[Kt]||Lt.keys[jt])}function Yt(){return Lt.keys&&Lt.keys[Zt]}function Wt(){return Lt.keys&&Lt.keys[Ft]}var Pt=37,_t=39,Ut=38,Kt=40,Gt=87,Xt=65,jt=83,Nt=68,Ft=77,zt=0,Vt=2,Zt=32,qt=49,Jt=50,Qt=51,$t=52,te=82,ee=0,ie=1,se=2,he=3,oe=4,ne=5,re=6,ae=7;function le(){this.ammo=vt,this.bullets=[],this.rate=.1,this.wait=0,this.type=E.ONESHOT,this.angles=[0],this.r=.0174533,this.addBullets=function(t,e,i,s,h=!1,o=null,n=null){if(this.ammo>0&&this.wait<=0){this.wait=this.rate;var r=Math.atan2(s-e,i-t);this.type==E.ONESHOT?this.angles=[0]:this.type==E.TWOSHOT?this.angles=[-5,5]:this.type==E.THREESHOT?this.angles=[0,15,-15]:this.type==E.MULTISHOT&&(this.angles=[0,-20,-40,-60,20,40,60]),o==L.TNY&&(this.angles=[0,90,-90,180]),this.angles.forEach((i,s)=>{xx=t+60*Math.cos(r+i*this.r),yy=e+60*Math.sin(r+i*this.r),this.bullets.push(new ce(t,e,xx,yy,n))}),h||(kt.shakeTime=.2,a(re,.5),this.ammo--,0==this.ammo&&(this.noAmmo++,B("Out of ammo.")))}},this.drawBullets=function(t,e=!1){this.wait>0&&(this.wait-=t),this.bullets.forEach(i=>i.draw(t,e)),this.bullets=this.bullets.filter(function(t){return 1==t.active})}}function ce(t,e,i,s,h=null){this.scale=4,this.speed=null!=h?h:mt,this.w=50,this.h=20,this.mhWidth=this.w/-2,this.mhHeight=this.h/-2,this.dst=0,this.active=!0,this.hb=new H(t,e,this.w,this.h),this.colour=null!=h?I():"#a12161",this.dist=0,this.accuracy=.1,this.v=new U(t+10,e+10),dir=Math.atan2(e-s,t-i)+Math.PI+2*(Math.random()-.5)*this.accuracy,this.dx=Math.cos(dir),this.dy=Math.sin(dir),this.angle=Math.atan2(e-s,t-i),this.checkHits=function(t,e=!1){_(t.hb,this.hb)&&t.hp>=0&&(t.hp--,this.active=!1,t.hp<0&&(Y(0,100)>90&&(r=Math.floor((t.y-t.mhHScaled)/64),c=Math.floor((t.x-t.mhWScaled)/64),tile=kt.level.tiles[c+19*r],tile.entity.type=L.HP,tile.entity.setType()),a(ne,.5),t.isBarrel()?(t.sx=0,t.sy=48):t.isTree()?t.sy=48:t.active=!1,t.isSolid=!1))},this.draw=function(t,e=!1){this.active&&(xx=this.v.x,yy=this.v.y,this.v.x+=this.dx*t*this.speed,this.v.y+=this.dy*t*this.speed,this.dist+=Math.sqrt((this.v.x-xx)*(this.v.x-xx)+(this.v.y-yy)*(this.v.y-yy)),(this.v.x<0||this.v.x>1300||this.v.y<0||this.v.y>840||this.dist>bt)&&(this.active=!1),this.hb.x=this.v.x+this.mhWidth,this.hb.y=this.v.y+this.mhHeight,e||kt.level.mobs.forEach(t=>this.checkHits(t.entity)),e&&this.checkHits(kt.hero.e),kt.level.breakTiles.forEach(t=>this.checkHits(t.entity)),ctx.save(),ctx.translate(this.v.x,this.v.y),ctx.rotate(this.angle),ctx.globalAlpha=.5,ctx.fillStyle="white",ctx.fillRect(this.mhWidth+.25,this.mhHeight+.25,this.w+.25,this.h+.25),ctx.globalAlpha=.8,ctx.fillStyle=this.colour,ctx.fillRect(.5*this.mhWidth,.5*this.mhHeight,.5*this.w,.5*this.h),ctx.restore())}}